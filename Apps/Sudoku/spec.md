# ナンプレアプリ仕様書 (Sudoku Single-File App)

**バージョン:** 1.3.0
**更新日:** 2025年12月27日
**ターゲット:** シニア層（視覚過敏・手術後対応）および高パフォーマンス志向ユーザー
**ファイル構成:** シングルHTMLファイル（画像・CSS・JS・Manifest全て内包）

---

## 1. プロジェクト概要
本アプリは「インストール不要、通信不要、ストレスフリー」を掲げた、シニア特化型のナンプレアプリです。
一般のアプリと異なり、**「間違った瞬間に気付けるリアルタイム判定」**と**「人間的な思考で解ける良問生成」**を特徴とします。

### 主要コンセプト
1.  **Universal Design:** 白内障や老眼に配慮した「アイボリー背景＋濃紺文字」。
2.  **Logic First:** 「理不尽な難問（勘に頼る問題）」を排除したロジック重視の生成エンジン。
3.  **Modern PWA:** ストアを経由せず、ブラウザから直接ホーム画面に高品質なアプリとして追加可能。

---

## 2. 技術仕様 (Technical Stack)

### アーキテクチャ
*   **言語:** HTML5, CSS3, JavaScript (ES2020+)
*   **依存ライブラリ:** なし (Vanilla JS 100%)
*   **PWA実装:** **Dynamic Manifest Injection (Blob URL方式)**
    *   *特徴:* JS内でJSONをBlob化し、動的に `<link rel="manifest">` を生成・注入する方式を採用（一部Androidでのブロック回避のため）。
    *   *アイコン:* SVGをBase64化し、`<link rel="icon">` および `<link rel="apple-touch-icon">` に設定。

### データ保存 (LocalStorage)
*   **Key:** `seniorSudokuApp_v4`
*   **保存内容:**
    *   `puzzle`: 現在の盤面
    *   `memos`: メモ書きの状態
    *   `fixed`: 初期配置フラグ
    *   `isComplete`: クリア状態フラグ
    *   `diffKey`: 選択中の難易度
*   **除外:** `history` (Undo用スタック) は容量削減のため保存しない。

---

## 3. UI/UX仕様 (Design System)

### 配色 (Color Palette)
視覚負担を最小限に抑えるため、以下のカラーコードを厳守すること。

| 用途 | 色名 | コード | 備考 |
| :--- | :--- | :--- | :--- |
| **背景** | Ivory | `#F5F5DC` | 純白は禁止（ハレーション防止）。 |
| **文字** | Dark Navy | `#000033` | 黒(#000)よりも柔らかく、視認性が高い。 |
| **エラー** | Red | `#D00000` | **即時判定用**。誤入力した数字に使用。 |
| **選択セル** | Pale Yellow | `#FFFFA0` | 選択中のマス。 |
| **十字強調** | Pale Gray | `#EBEBE0` | **クロスハイライト**。選択セルの縦横列。 |
| **枠線** | Dark Gray | `#555555` | コントラスト比を確保した枠線。 |

### レイアウト挙動 (Responsive)
`CSS Grid` により、デバイスの向きに応じてUI配置を再構築する。

1.  **縦画面 (Portrait)**
    *   配置: ヘッダー(機能) → 盤面 → 数字キー (サンドイッチ配置)。
    *   特徴: 片手操作に最適化。
2.  **横画面 (Landscape)**
    *   配置: 左に盤面(最大化) / 右に操作パネル。
    *   特徴: 縦幅が狭い機種での「上部見切れ」を防ぐため、`overflow-y: auto` でスクロール可能にする。
    *   ボタン: ヘッダーが非表示になるため、サイドパネル内に「使い方」「新規」「保存」ボタンを出現させる。

---

## 4. エンジン仕様 (Logic & Difficulty)

### 生成アルゴリズム
`Bitmask`（ビット演算）による高速ソルバーと、`Logic Simulator`（人間的思考模倣）を組み合わせたハイブリッドエンジン。

### 難易度定義
難易度は「穴の数」だけでなく、「解くのに必要なロジック」で制御される。

| 難易度 | 穴数目安 | ロジック制限 (Logic Check) | アルゴリズム挙動 |
| :--- | :--- | :--- | :--- |
| **かんたん** | 36 | **Naked Single** (裸のシングル) | 「候補が1つしかないマス」を埋めるだけで必ず解ける問題を保証。 |
| **ふつう** | 46 | **Hidden Single** (隠れたシングル) | 「この列で1が入れるのはここだけ」という推論が必要。 |
| **むずかしい** | 54 | 制限なし (Unique Only) | ロジック判定を行わず、答えが1つであることだけを確認。広い視野が必要。 |
| **達人** | 62 | 制限なし (Unique Only) | ヒント数が極限まで少ない。高度な定石や仮置きが必要な場合もある。 |

### 安全装置
*   **タイムアウト:** 生成処理が `2000ms` を超えた場合、強制的に処理を打ち切り、その時点での盤面（または再試行）へ移行する。ブラウザのフリーズを完全防止。

---

## 5. 機能詳細

### リアルタイム判定 (Real-time Error)
*   **仕様:** 数字入力時、即座に正解データと比較を行う。
*   **挙動:** `puzzle[r][c] !== solution[r][c]` の場合、即座にCSSクラス `.error-text` を付与。
*   **目的:** 「全部埋めた後に間違いに気づく絶望」を高齢者に味わわせないため。

### インストールボタン (PWA)
*   **仕様:** ブラウザが PWA としてインストール可能と判断した場合（`beforeinstallprompt` イベント発火時）のみ、「⬇️ 保存」ボタンを表示する。
*   **挙動:** ボタン押下でOS標準のインストールダイアログを呼び出す。iOSなど非対応環境ではボタン自体が表示されない。

### 隠し機能
*   **誕生日:** 2月20日に起動すると、初回のみお祝いメッセージを表示する（`localStorage` で制御）。

---

## 6. 保守・引継ぎガイド

1.  **コードの修正:**
    *   全てのコードは1つのHTMLファイル内にあります。CSSやJSを別ファイルに分割しないでください（「ファイルをなくした」というトラブルを防ぐため）。
2.  **アイコンの変更:**
    *   アイコンを変更する際は、SVG画像をBase64エンコードし、HTMLヘッダー内の `<link rel="icon" ...>` および JS内の `const iconSVG = "..."` の2箇所を更新してください。
3.  **既知の制約:**
    *   iOS Safariでは「ホーム画面に追加」ボタンをスクリプトから呼び出せない仕様のため、「⬇️ 保存」ボタンは表示されません（手動で「共有」→「ホーム画面に追加」を行う必要があります）。これは仕様です。
